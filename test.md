### <a name=\"导语\">导语</a>\n公司现有的发版模式，对前端甚不友好，未构建前端自动化打包流程。\n\n### <a name=\"现状\">现状</a>\n三种前端发版模式\n\n一、依赖于后端public目录，前端完全附属于后端项目。\n|-- pulic 后端静态目录\n|---- src 源码目录\n|---- build 实际打包之后代码\n|---- ....\n\n优点\n后端程序能在一个项目里又写前端又写后端???\n\n缺点\n1、前后端需一起发版，前后开发不能完全解耦。\n2、前端源码目录不需要同步到服务器，浪费额外的空间。\n\n二、前端独立建项目，本地打包，上传build文件。在通过修改nginx配置或代理虚拟目录\n\n优点\n前后端独立发版。\n\n缺点\n需要本地打包，并新建目录或项目同步至服务器，手动过程。\n\n三、同步整个文件至服务器，服务器打包，删除无用文件。\n\n优点\n发版只关注文件是否同步\n\n缺点\n1、目标服需配备前端打包环境，node、npm、node_modules等。非runtime的node_modules不需要存在。\n2、需在服务器上手动操作，即使写为shell脚本。\n\n而jenkins就改善了前端发版。jenkins不是一款为前端而生的工具，java、app等打包程序都可以使用。\n\n### <a name=\"环境搭建\">环境搭建</a>\n笔者采用centos 7.2 64位系统\n#### <a name=\"安装jenkins\">安装jenkins</a>\njenkins依赖java\n查看yum源java列表\n```\nsudo yum list java*\n```\n这里我们安装java8（jenkins需安装8以上版本）\n```\nsudo yum install  java-1.8.0-openjdk\n// 查看是否安装成功\njava -version\n```\n安装jenkins（之所以用yum安装，可直接注册服务，而不用每次启动jar程序）\n```\n// 添加jenkins源\nsudo wget -O /etc/yum.repos.d/jenkins.repo http://jenkins-ci.org/redhat/jenkins.repo\n// 注册rpm\nsudo rpm --import http://pkg.jenkins-ci.org/redhat/jenkins-ci.org.key\n// 安装\nsudo yum install jenkins\n```\n端口修改\n```\nvim /etc/sysconfig/jenkins\n// 默认未8080，被占用时，可修改\nJENKINS_PORT='8080'\n// 重启\nservice jenkins restart\n// 关闭\nservice jenkins stop\n// 开启\nservice jenkins start\n```\n浏览器访问ip+端口，之后傻瓜式操作，注册用户，插件使用默认推荐插件。\n这时候将看到\n<img src=\"/static/image/微信截图_20180507124417.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n使用刚才注册的用户登陆\n<img src=\"/static/image/微信截图_20180507124757.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n安装完成\n#### <a name=\"安装gitlab\">安装gitlab</a>\ngitlab为非必要条件，github同样可触发webhooks。\n安装gitlab\n官网：https://about.gitlab.com/installation/#centos-7\n参照官网命令\n配置\n```\n// 注意设置访问地址\nsudo EXTERNAL_URL=\"${port or ip}\" yum install -y gitlab-ee\n// 也可在之后的配置文件中修改\nvim /etc/gitlab/gitlab.rb\nEXTERNAL_URL=xxx.xxx.xxx.xxx\n// 默认为8080，若占用需要修改端口，否则会导致500错误\nunicorn['port']=8080\n// 配置生效(该过程或许会很漫长)\nservice gitlab-ctl reconfigure\n// 重启\nservice gitlab-ctl restart\n```\n浏览器范访问\n502！\n百思不得解，谷歌上各种配置修改都没用。最后发现时内存不够，阿里云入门机只有2G的内存。\n<img src=\"/static/image/微信截图_20180507170309.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n万能的linux提供了swap分区，但是阿里云装机时不能不配置swap分区，需手动在shell中配置。\n```\n// 创建swap分区，设置一个8G的swap分区\nmkdir /data\ndd if=/dev/zero of=/data/swap bs=1073742000 count=8\n// 修改内核参数，当使用率超过60%，使用swap交换空间\nvim /etc/sysctl.conf\nvm.swappiness=60\n// 使配置生效\nsysctl -p\n// 启动swap分区\nswapon /data/swap\n```\n访问浏览器\n<img src=\"/static/image/微信截图_20180507173008.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n注册账号，gitlab安装完成。\n### <a name=\"集成配置\">集成配置</a>\ngitlab创建一个项目名为vue，本地git push 代码。\n<img src=\"/static/image/微信图片_20180507173459.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n一个vue-cli创建的前端项目\nsetting => Access Tokens =>Create pression access token => copy token\n创建一个全局的权限token，Express at过期时间可以忽略不设。保留该token，退出该页面后不可再查看。\n<img src=\"/static/image/微信截图_20180507173702.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n项目触发器设置\nURL 设为 http://${ip}/gitlab/build_send/${project}，  project为jenkins创建项目。在每次分支发送push时，触发钩子，发送请求于jenkins。\n<img src=\"/static/image/微信图片_20180507174224.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n\n#### <a name=\"jenkins配置\">jenkins配置</a>\n系统管理 => 插件管理 => 可选插件\n<img src=\"/static/image/微信截图_20180507174552.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n安装gitlab plugin，nodejs plugin， pulish over ssh，ssh plugin\n<img src=\"/static/image/微信截图_20180507174904.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n<img src=\"/static/image/微信截图_20180507174920.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n<img src=\"/static/image/微信截图_20180507174931.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n<img src=\"/static/image/微信截图_20180507174957.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n#### <a name=\"gitlab配置\">gitlab配置</a>\n系统管理 =>  系统设置 => Gitlab\nhost为gitlab的网络地址\n<img src=\"/static/image/火星图片_20180507_175850.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\nadd => Gitlab API token => API token => 输入gitlab生产的presonal access token\n<img src=\"/static/image/火星截图_20180507_180022.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n点击test Connection\n<img src=\"/static/image/火星截图_20180507_180230.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n应用 => 保存\n#### <a name=\"node配置\">node配置</a>\n系统管理 => 全局工具配置 => node\n<img src=\"/static/image/火星截图_20180507_180353.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n也可不使用自动安装，选择全局node路径\n<img src=\"/static/image/火星截图_20180507_180443.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n应用 => 保存\n#### <a name=\"ssh服务器配置\">ssh服务器配置</a>\nssh服务器就是远程部署代码的生产服\n查看jenkins服务器是否有ssh密码\n```\ncd /root/.ssh\nls -a\nid_rsa id_rsa.pub\n```\n若无，生成ssh\n```\nssh-keygen -c ${email}\n````\nPassphrase 输入密码的密码，若无设置，则跳过。\npath to key 输入id_rsa私钥\nHostname 远程ip\nusername 用户名 root\nremote Directory 远程同步目录\n<img src=\"/static/image/火星截图_20180507_181251.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\nTest Configuration => success => 应用 => 保存\n#### <a name=\"创建项目\">创建项目</a>\n新建项目 => 创建一个自由风格的软件项目\n<img src=\"/static/image/火星截图_20180507_181712.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\ngeneral，选择配置的gitlab\n<img src=\"/static/image/火星截图_20180507_184627.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n设置源码，可配置用户名密码登陆，或者使用ssh连接， 设置master分支\n<img src=\"/static/image/火星截图_20180507_184815.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n设置构建触发器，日程表设置为空时，将会被webhooks调用\n<img src=\"/static/image/火星截图_20180507_184950.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n构建环境，选择node和npm设置\n<img src=\"/static/image/火星截图_20180507_185218.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n构建配置，选择执行shell脚本，注意前端文件较多，压缩处理为zip格式\n<img src=\"/static/image/火星截图_20180507_185255.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n构建后操作，选择Send build artifacts over SSH，设置远程服务器，注意$BUILD_ID为构建id\n<img src=\"/static/image/火星截图_20180507_185408.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n保存 => 应用\n#### <a name=\"执行\">执行</a>\n<img src=\"/static/image/火星截图_20180507_185714.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n\n### <a name=\"github配置\">github配置</a>\n对于个人仓库而言，还是使用github较多，而github同样支持webhook。顺带提及一下。\nsetting => Develop setting => Personal access tokens => Generate new token => 选择如下配置，同样的这个密钥只出现一次，保存为好\n<img src=\"/static/image/火星截图_20180508_142526.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n同样的在jenkins => 系统管理 => 系统设置 => github Server中输入，API URL 输入官方api地址，而非个人仓库\n<img src=\"/static/image/火星截图_20180508_143121.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n添加密钥 => Secret text => Secret => 输入github密钥\n<img src=\"/static/image/火星截图_20180508_143253.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\njenkins项目配置\n勾选github project，project url 输入项目地址，不包含.git后缀\n<img src=\"/static/image/火星截图_20180508_143511.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\nRepository URL 输入clone地址，https后者ssh都可以\n选择密钥，不再熬述。\n选择对应分支。\n<img src=\"/static/image/火星截图_20180508_143638.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\n触发器选择 github hook\n<img src=\"/static/image/火星截图_20180508_144043.png\" width=\"100%\" height=\"100%\" alt=\"\"/>\nok！当代码提交时，将会自动触发\n